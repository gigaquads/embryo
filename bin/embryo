#!/usr/bin/env python3
# encoding=utf8
# vim: set filetype=python

from appyratus.util.argz import Prog, Subparser, Arg
from appyratus.util import DictUtils

from embryo import Loader


PROG = dict(
    prog="embryo",
    name="Embryo",
    version="0",
    tagline="wat",
)


class EmbryoCreateSubparser(Subparser):
    name = 'create'
    help = 'generate new embryo'
    defaults = dict(action='create')

    embryo_arg = Arg(
        flags=('embryo', ),
        type=str,
        help="The name of the embryo for embryonic generation."
    )
    dest_arg = Arg(
        flags=('-d', '--dest'),
        type=str,
        default='./',
        help=
        "Destination path to the directory where the embryo should be generated."
    )
    context_arg = Arg(
        flags=('-c', '--context'),
        help="Path to a context .json or .yml file.",
    )


class EmbryoProg(Prog):
    create_subparser = EmbryoCreateSubparser()

    def parse_generator_kwargs(self):
        """
        Generate en embryo using command line (CLI) arguments as the initial
        context dict (before the context.yml/json file is merged in, etc.)
        """
        cli_kwargs = {  # command-line (CLI) kwargs
            k: getattr(self.args, k)
            for k in dir(self.args) if not k.startswith('_')
        }

        return dict(
            name=cli_kwargs['embryo'],
            context=DictUtils.unflatten_keys(cli_kwargs),
        )

    def create(self):
        loader = Loader()
        loader.load(**self.parse_generator_kwargs())
        return loader.build()


def main():
    """
    Main
    """
    prog = EmbryoProg(data=PROG)
    prog.run()


if __name__ == "__main__":
    try:
        main()
    except Exception as error:
        print("ERROR {}".format(error))
        raise error
